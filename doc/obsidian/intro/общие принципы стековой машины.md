# общие принципы стековой машины


- минимальный компьютер состоит из
	- `CPU`: процессор
	- `RAM`: ОЗУ
	- `IO`: самое простое устройство ввода/вывода
		- `UART`: последовательный порт, умеет посылать и принимать символы
	- всё это объединено шиной (архитектура Фон-Неймана)
- процессор выполняет команды
	- минимально адресуемый элемент ОЗУ -- один байт, поэтому команда кодируется [[опкод|опкодом]] в один байт
	- для операций нужно временное хранение данных
	- между операциями данные хранятся
		- в очень быстром, но маленьком временном хранилище
		- в большом но медленном ОЗУ

## регистры

Практически все современные процессоры регистровые, и умеют выполнять одновременно несколько операций, но с разными независимыми регистрами
- так как количество регистров ограничено (R0..R7/R15), программисту сложно следить где какие данные хранятся и как они там мельтешат между операциями
- для компилятора нужно применять нетривиальный [[алгоритм распределения регистров]] и постоянно делать загрузку/выгрузку регистры`<->`ОЗУ

## [[стек]]

Для языков программирования часто используется более высокоуровневое временное хранилище: [[стек]]
- языки типа C/C++ используют аппаратный стек, в котором адреса возврата из функции, аргументы функции и локальные переменные смешаны в одном [[стек#фрейм|стековом фрейме]]
- языки типа Java/C# используют программный стек в куче (?), так как им нужно больше возможностей контроля над данными в стеке (проверка типов, управление памятью)
- язык [[Форт]] использует *два отдельных стека*, разделяя данные и адреса возврата из подпрограммы (функции, процедуры)
	- **глобальный** [[стек данных]] позволяет использовать интересный метод: [[конкатенативное программирование]]
	- [[стек возвратов]] хранит только адреса для команд [[call]]/[[ret]]

## cтековая машина

*Стековая машина* -- виртуальный компьютер, или [[виртуальная машина]], у которой нет регистров, а все операции определены над вершиной стека:
- [[lit]]: положить константу
- арифметика: взять два аргумента из стека, [[add|сложить]], и положить в стек результат
```Forth
: addition ( 2 3 -- 5 ) # сложение
	lit 2
	lit 3
	add
```
- [[ld|загрузка]]/[[st|выгрузка]] данных между стеком и ОЗУ, используя [[u32]] адрес
- команды условного/безусловного перехода и вложенного вызова: [[jmp]], [[qjmp]], [[call]], [[ret]]
- команды управления системой: [[halt]]
- расширенные наборы команд: [[sdl]]

## машинное слово `CELL:u32`

 В Форте есть такое понятие как [[CELL]] или [[машинное слово]]:
- целое число с которым процессор умеет выполнять операции с помощью одной команды
- часто под машинным словом имеется в виду адрес памяти: чем больше бит в одном машинном слове, тем больше памяти доступно вашей программе
	- на 8- и 16-битных процессорах размер слова 16 бит, и процессор может адресовать не более чем $2^{16}=64K$ ОЗУ (65536 байт)
	- на 32-битных компьютерах и микроконтроллерах адресуется соответственно 4Gb ОЗУ -- **вполне достаточно для большинства задач**
	- адресация современных 64-битных процессоров практически не ограничена, и имеет смысл разве что для хранилищ данных, и обработки видео

В реализации виртуальной машины `skelex` был выбран ограниченный размер [[CELL]] = 32bit
	- 32-битной адресации и арифметики вполне достаточно для большинства задач, по крайней мере в учебных целях
	- как один из вариантов, будет рассматриваться реализация для микроконтроллеров и самых дешевых [[SoC]]
	- 64-битная адресация будет есть память под ненужные старшие байты адресов, как минимум 4-6 байт на каждое целое или адрес
	- для IoT-устройств очень важен размер бинарных пакетов данных и программ, поэтому при работе через сети LPWAN (LoRa/NB-IoT) с батарейным питанием есть смысл обрезать машинное слово до 16 bit

